<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Our Locations</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: #ffffff;
      background-color: #012169;
    }

    header {
      padding: 30px 20px 10px;
      background-color: #012169;
      text-align: center;
    }

    header h1 {
      font-size: 2.2rem;
      color: #ffffff;
      margin-bottom: 10px;
    }

    header p {
      font-size: 1.1rem;
      max-width: 700px;
      margin: 0 auto;
      color: #012169;
    }

    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
      position: relative;
    }

    /* Map takes full width (the side panel will overlay it) */
    #map {
      height: 75vh;
      width: 100%;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Keep Leaflet popup width reasonable */
    .leaflet-popup-content {
      max-width: 400px !important;
      width: 100%;
    }

    .popup-scroll-container {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .school-toggle-button {
      width: 100%;
      text-align: left;
      padding: 8px;
      background: #f0f0f0;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }

    /* --- Side panel (new) --- */
    #side-panel {
      position: fixed;
      top: 0;
      right: -420px; /* hidden by default */
      width: 420px;
      height: 100%;
      background: #ffffff;
      color: #012169;
      box-shadow: -6px 0 24px rgba(0,0,0,0.25);
      transition: right 0.28s ease;
      z-index: 10000;
      overflow-y: auto;
      padding: 18px;
      border-left: 1px solid rgba(0,0,0,0.06);
      font-size: 15px;
    }

    #side-panel.active { right: 0; }

    #side-panel header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 12px;
    }

    #side-panel h2 { margin: 0; font-size: 1.15rem; }

    .close-panel-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
    }

    .school-card {
      background: #fff;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04);
    }

    .school-card h3 { margin: 0 0 6px 0; font-size: 1rem; }
    .school-card p { margin: 6px 0; color: #333; font-size: 0.95rem; }

    .school-actions { margin-top: 10px; display:flex; flex-direction:column; gap:8px; }

    .action-btn {
      padding: 10px;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .action-btn.read-more { background: #012169; }
    .action-btn.prayer { background: #012169; }
    .action-btn.revival { background: #012169; }

    @media (max-width: 900px) {
      #side-panel { width: 100%; right: -100%; }
      #side-panel.active { right: 0; }
      #map { height: 60vh; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Our Locations</h1>
    <p>
      We have various locations to choose from. Click on a pin on the map, select a school or university,
      and decide whether you want to read more about the school, adopt it for prayer, or for revival.
    </p>
  </header>

  <div class="container">
    <div id="map"></div>
  </div>

  <!-- Side panel (populated dynamically) -->
  <aside id="side-panel" aria-hidden="true">
    <header>
      <h2 id="panel-city">City</h2>
      <button class="close-panel-btn" onclick="closePanel()" aria-label="Close panel">✖</button>
    </header>
    <div id="panel-content">
      <!-- Injected school cards will go here -->
    </div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // --- existing data sources, untouched (still reads localStorage) ---
    const cityCoords = {
      London: [51.5074, -0.1278],
      Manchester: [53.4808, -2.2426],
      Birmingham: [52.4862, -1.8904],
      Glasgow: [55.8642, -4.2518],
      Edinburgh: [55.9533, -3.1883],
      Liverpool: [53.4084, -2.9916],
      Bristol: [51.4545, -2.5879],
      Leeds: [53.8008, -1.5491],
      Sheffield: [53.3811, -1.4701],
      Newcastle: [54.9783, -1.6178],
      Nottingham: [52.9548, -1.1581],
      Southampton: [50.9097, -1.4044],
      Portsmouth: [50.8198, -1.0880],
      Brighton: [50.8225, -0.1372],
      Plymouth: [50.3755, -4.1427],
      Cardiff: [51.4816, -3.1791],
      Belfast: [54.5973, -5.9301],
      Derby: [52.9225, -1.4766],
      Coventry: [52.4068, -1.5197],
      Hull: [53.7676, -0.3274],
      Dundee: [56.4620, -2.9707],
      Aberdeen: [57.1497, -2.0943],
      Inverness: [57.4778, -4.2247],
      Swansea: [51.6214, -3.9436],
      Reading: [51.4543, -0.9781],
      Leicester: [52.6369, -1.1398],
      Bradford: [53.7950, -1.7594],
      Oxford: [51.7520, -1.2577],
      Cambridge: [52.2053, 0.1218],
      StAndrews: [56.3398, -2.7967],
      Bangor: [53.2270, -4.1297],
      Aberystwyth: [52.4153, -4.0829],
      Coleraine: [55.1320, -6.6696],
    };

    // Map & tile layer
    const map = L.map('map').setView([54.5, -3], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Read your saved data (unchanged)
    const savedCities = JSON.parse(localStorage.getItem('cities')) || [];
    const cityChildren = JSON.parse(localStorage.getItem('cityChildren')) || {};

    // Keep marker refs by city if we need them later
    const markersByCity = {};

    // Build markers and popups using your existing dynamic data
    savedCities.forEach(city => {
      const coords = cityCoords[city];
      if (!coords) return;

      const marker = L.marker(coords).addTo(map);
      markersByCity[city] = marker;

      const schools = cityChildren[city] || [];

      let schoolListHTML = `<div><strong>${city}</strong>`;
      if (schools.length === 0) {
        schoolListHTML += `<p>No schools/universities added.</p>`;
      } else {
        schoolListHTML += `<div class="popup-scroll-container"><ul style="list-style:none; padding-left:0;">`;

        schools.forEach((school, index) => {
          // use an escaped city value for safe embedding in onclick
          const escCity = city.replace(/'/g, "\\'");
          schoolListHTML += `
            <li style="margin-bottom:10px;">
              <!-- When a user clicks a school, open the side panel (instead of expanding inline) -->
              <button onclick="openSchoolPanel('${escCity}', ${index})" class="school-toggle-button">
                ${school.name || 'Unnamed School'}
              </button>
            </li>`;
        });

        schoolListHTML += `</ul></div>`;
      }

      schoolListHTML += `</div>`;
      marker.bindPopup(schoolListHTML);
    });

    // --- New behavior: side panel functions ---
    function openSchoolPanel(cityName, index) {
      // Close any open popup (keeps UI tidy)
      if (map && map.closePopup) map.closePopup();

      const schools = cityChildren[cityName] || [];
      const school = schools[index];
      if (!school) return;

      // Populate the panel
      const panelCity = document.getElementById('panel-city');
      const panelContent = document.getElementById('panel-content');
      panelCity.textContent = cityName;
      panelContent.innerHTML = ''; // clear

      // You might have multiple schools for a city; show the one clicked.
      // Build a single card for the selected school (you can expand to list all if required)
      const card = document.createElement('div');
      card.className = 'school-card';

      const title = document.createElement('h3');
      title.textContent = school.name || 'Unnamed School';
      card.appendChild(title);

      const about = document.createElement('p');
      about.innerHTML = `<strong>About:</strong> ${school.About || 'N/A'}`;
      card.appendChild(about);

      const accred = document.createElement('p');
      accred.innerHTML = `<strong>Accreditation & Ranking:</strong> ${school.accreditation || 'N/A'}`;
      card.appendChild(accred);

      const schol = document.createElement('p');
      const scholText = school.scholarships === 'yes' ? 'Yes' : (school.scholarships === 'no' ? 'No' : 'N/A');
      schol.innerHTML = `<strong>Scholarships Available:</strong> ${scholText}`;
      card.appendChild(schol);

      const visa = document.createElement('p');
      const visaText = school.visaSupport === 'yes' ? 'Yes' : (school.visaSupport === 'no' ? 'No' : 'N/A');
      visa.innerHTML = `<strong>Visa Support:</strong> ${visaText}`;
      card.appendChild(visa);

      // buttons
const actions = document.createElement('div');
actions.className = 'school-actions';

const readBtn = document.createElement('button');
readBtn.className = 'action-btn read-more';
readBtn.onclick = () => {
  window.location.href = 'read-more.html?city=' + encodeURIComponent(cityName) + '&index=' + index;
};
readBtn.textContent = 'Read More';
actions.appendChild(readBtn);

const prayerBtn = document.createElement('button');
prayerBtn.className = 'action-btn prayer';
prayerBtn.onclick = () => { 
  window.location.href = 'adopt-prayer.html?city=' + encodeURIComponent(cityName) + '&index=' + index; 
};
prayerBtn.textContent = 'Adopt for Prayer';
actions.appendChild(prayerBtn);

const revivalBtn = document.createElement('button');
revivalBtn.className = 'action-btn revival';
revivalBtn.onclick = () => { 
  window.location.href = 'adopt-revival.html?city=' + encodeURIComponent(cityName) + '&index=' + index; 
};
revivalBtn.textContent = 'Adopt for Revival';
actions.appendChild(revivalBtn);


card.appendChild(actions);
panelContent.appendChild(card);


      // Show the panel
      const panel = document.getElementById('side-panel');
      panel.classList.add('active');
      panel.setAttribute('aria-hidden', 'false');
    }

    function closePanel() {
      const panel = document.getElementById('side-panel');
      panel.classList.remove('active');
      panel.setAttribute('aria-hidden', 'true');
    }

    // Close with Escape key (nice to have)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePanel();
    });

    // If you want clicking outside the panel to close it (optional)
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('side-panel');
      if (!panel.classList.contains('active')) return;
      const inside = panel.contains(e.target);
      const isPopupButton = e.target.closest('.leaflet-popup');
      // If click is outside the side panel and not inside a popup, close panel
      if (!inside && !isPopupButton) {
        closePanel();
      }
    });
  </script>
</body>
</html>
